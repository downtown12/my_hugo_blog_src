---
title: "随笔: 一次渗透演习过程中的信息收集工作"
subtitle: "Information Gathering During Penetration Testing Targeting an Internal System"
date: 2018-07-29T17:46:27+08:00
draft: true
categories:
  - "安全"
tags:
  - "渗透测试"
  - "信息收集"
---

最近参加了一个政府机构组织的网络安全演习工作，演习的目的是通过在可控环境（在该机构提供的可控环境下实施渗透）中，尝试获取一些国内重要行业的信息系统的权限，以评价此系统及系统所在网络的安全性。以达到网络安全演习的目的。

因此，我的工作就是针对目标网络做渗透。通过各种手段，尝试进入目标网络的内网，取得权限。简单说就是在互联网上搜集目标网络这在安全方面“短板”，尤其是搜集一些安全基线配置不到位的地方，例如：弱口令、开放到互联网的敏感端口等。

在这次演习过程中，我在信息收集方面收获了不少经验，在这里记录、分享一下。

## 演习目标

通过目标系统在互联网上开放的服务，一步一步从互联网入口、进入内网、甚至进一步进入内网生产网，拿下生产网核心系统的权限。

## 整体思路

通过和身边经验丰富的大佬交流，再结合自己的实践。总结出一套在外部，对目标网络的内网进行渗透的信息收集经验。也就是说我们的渗透目标，是拿下某公司内部局域网办公网or生产网系统的某些权限。

## 渗透思路

寻找水桶上最短的那块木板：

1. 扫描子域名 （获取搜索引擎上的一些已知子域名和对应IP）
    借助工具：subDomainsBrute by lijiejie, SubdomainCollector by 小米范
    子域名收集的原理：利用子域名字典探测二级或者三级域名，在通过dns解析得知此域名是否存在。
    例如：很多网站喜欢将邮件系统的web服务的域名命名为mail.xx.com, 例如：mail.163.com, mail.qq.com。于是就可以将"mail"加入到子域名字典中。字典中类似的词语还可以是dns, smtp, test等等。
2. 判断网络IP的真实位置。通过DNS得到的IP地址可能有以下几种情况：目标系统数据中心外网真实IP、CDN网段或者内网IP。
3. 绕过CDN得到真实的IP地址。方式汇总：

    a. 借助一些支持多地点ping操作的工具网站。如：
    * http://ping.chinaz.com
    * https://ping.aizhan.com/

    一些站点支持多地理位置ping,可在这些网站上对目标域名执行ping操作，如果不同的地理位置返回的是同一个IP，则找到了。
4. 扫描真实IP对应的C段，发现目标所开放的服务端口
5. 根据扫到的端口，根据常用端口和对应的服务，做进一步的探测：
    * **80、443端口（web服务）**：直接浏览器访问了解情况、用whatweb探测设备指纹，了解网站的开发框架。同时，可排除一些无效站点，例如：服务器无响应、返回404或空内容。根据网站情况，进行进一步的渗透。
    * **8080、8000、8888, etc**：这些端口通常也可能会开放一些web服务，可通过上边的方法做一些测试或尝试。
    * **21端口（ftp）**：用F-Scrack或hydra工具探测弱口令。根据之前的实践经验，探测出弱口令的机会不大。
    * **22端口（ssh）**：用hydra或fenghuang-scan工具探测弱口令。根据之前实践经验，探测出弱口令的机会不大。
    * **7001、7002端口（疑似weblogic）**：尝试一些weblogic反序列化漏洞的检测，依赖公开PoC。如果检测出现漏洞，可直接获取服务器权限。
    * **3389（远程桌面or rdp协议）**：用windows上的mstsc.exe做一下探测，证明目标确实开放了远程桌面。进而可以使用hydra工具扫一下弱口令。
    * **3306（mysql）**：可以试一下弱口令扫描。工具的话，没错还是hydra。
    * ......
    

## 收获与反思：

1. 平时要注重对渗透技巧的训练和对渗透经验的积累。
2. 要提早编写几个趁手的工具，在实际工作中可以直接拿来使用。
